# Legno Compiler

compilation tools for automated analog configuration generation. `legno.py` is the toplevel file for compilation that contains several subtools:

**arco**: generate abstract chip configurations from differential equations.
**jaunt**: perform parameter and time scaling on abstract chip configurations to generate concrete chip configurations,
**srcgen**: generate `grendel` low-level scripts from a concrete chip configuration, given a the name of a math experiment specification (see `bmark/menvs.py`) and a hardware setup specification (`chip/hwenvs.py`). For example, `t20` is a math specification that executes the benchmark for 20 simulation units. If you're not using my oscilloscope, you need to use the `noosc` hardware environment.
**skelter**: given a library of concrete circuits, perform noise analysis on each one and rank them by noise level (`scores.txt` - higher is better). Can optionally generate a random sampling of `grendel` files (`grendel_list.txt`)

The `run.sh` script is a convenience script that runs the subtools in the correct order. To compile the dampened spring benchmark for 20 simulation units, for example, execute:

`run.sh spring t20 default`

Once the grendel files are generated, you can then execute them on the chip using the scripts included in the `lab_bench` directory. Refer to the `README.md` file in `lab_bench` for more information on how to setup the dependences for the interpreter. Once all of that is set up you can run grendel scripts in three ways:

This method runs all the grendel scripts listed in the file `grendel_list.txt` and plots the results:

   python3 chip_run.py spring --script-list grendel_list.txt

This method runs all the grendel scripts associated with a benchmark and plots the results:

   python3 chip_run.py spring
   
This method runs a single grendel script:

   python3 lab_bench/arduino_client.py --script /path/to/file.grendel


#### Notes

- make sure the grendel script has no `osc_*` commands if you're not using the Sigilent1020XE oscilloscope.

- make sure the arduino is connected via the programming port.

- make sure you have flashed `/lab_bench/arduino_due/arduino_driver/arduino_driver.ino` to the board. This program requires the `DueTimer` library be installed.

## Files Generated by the Compiler

`Legno` generates the following files for each benchmark:

   - `outputs/default/<BMARK>/abs-circs/`: The abstract circuits generated by `arco`. Each of these files is a json file that should be human readable.
   - `outputs/default/<BMARK>/abs-graphs/`: Graph visualizations of the abstract circuits generated by `arco`.
   - `outputs/default/<BMARK>/conc-circs/`: The concrete circuits generated by `jaunt`. Each of these files is a json file that should be human readable. The prefix of the file is the abstract circuit each concrete circuit is generated from.
   - `outputs/default/<BMARK>/conc-graphs/`: Graph visualizations of the concrete circuits generated by `jaunt`.
   - `outputs/default/<BMARK>/grendel/` : Grendel scripts of concrete circuits. These scripts are written in a low level language that `arduino_client.py` is able to interpret.
   - `outputs/default/<BMARK>/ref-waveforms/`: The reference waveforms for the differential equation. Note: there are bugs in the integration method.
   - `outputs/default/<BMARK>/out-waveforms/`: The waveforms measured from the chip. These waveforms are saved using the `micro_save_waveform` and `osc_save_waveform` commands.
   - `outputs/default/<BMARK>/plots/`: Waveform plots. Typically these plots compare the reference waveforms to the measured waveforms.
   
   
# Installing Legno Dependences

The Legno compiler requires `python3` and `pip3`. Install the dependences with the following command:

   pip3 install matplotlib scipy numpy 

Legno also requires a bleeding edge version of `gpkit`. Clone the following repository:

   git@github.com:convexengineering/gpkit.git
   
Then navigate to it in the command line, and execute the following command in the root directory:

   pip3 install -e .
   
# Caveats / Notes

- Legno currently does not use the LUT component in its configurations.
- Legno makes use of a hardware specification of the HCDC hardware for compilation (`chip/hcdc.py`).
- make sure all benchmarks/hardware environments/math environments are one word, no spaces or special characters.
