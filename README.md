# Legno Compiler

compilation tools for automated analog configuration generation. `legno.py` is the toplevel file for compilation that contains several subtools:

**arco**: generate abstract chip configurations from differential equations.

   ./run_arco.sh <bmark>
   
**jaunt**: perform parameter and time scaling on abstract chip configurations to generate concrete chip configurations.

   ./run_jaunt.sh <bmark>
   
**srcgen**: generate `grendel` low-level scripts from a concrete chip configuration, given a the name of a math experiment specification (see `bmark/menvs.py`) and a hardware setup specification (`chip/hwenvs.py`). For example, `t20` is a math specification that executes the benchmark for 20 simulation units. If you're not using the Sigilent1020XE oscilloscope, you need to use the `noosc` hardware environment.

   ./run_srcgen.sh <bmark> <hw-env>
   
**skelter**: given a library of concrete circuits, perform noise analysis on each one and rank them by noise level (`scores.txt` - higher is better). Can optionally generate a random sampling of `grendel` files (`grendel_list.txt`)

The `run_<toolname>.sh` script is a convenience script that runs the subtools with the correct arguments. To compile the dampened spring benchmark, for example, execute:

      run_arco.sh cosc
      run_jaunt.sh cosc
      run_skelter.sh cosc
      run_srcgen.sh cosc default
      
If you are not using the Sigilent Oscilloscope, use the `noosc` hardware environment.

      run_srcgen.sh cosc noosc
      
## Compiling the `.bb` physical models

navigate to `chip/hcdc/data` and execute the following:

   ./generate.sh

This command builds bias, noise and delay models for each block from empirical data, and writes them to `.bb` files

## Setting up the output directory

navigate to `util`, rename `config_local.py` to `config.py`. The `config.py` file has the following variables. 

   - `OUTPUT_DIR`: the output directory legno uses for writing circuits, graphs, datasets and so on. Due to some bugs in `paths.py`, you want to choose an output directory with no paranethesis, spaces or underscores.

   - `GPKIT_SOLVER`: the convex optimization solver `gpkit` uses. By default it is set to `mosek_cli`, the command line interface for the Mosek solver. If you don't have (or can't use), you can change the optimizer to `cvxopt`, though be warned it fails on some benchmarks. See the _Setting Up Mosek_ section for more information.
   
   
## Executing `.grendel` files

Once the grendel files are generated, you can then execute them on the chip using the scripts included in the `lab_bench` directory. Refer to the `README.md` file in `lab_bench` for more information on how to setup the dependences for the interpreter. Once all of that is set up you can run grendel scripts in three ways:
 
This method runs a single grendel script. We recommend starting with this:

    python3 grendel.py --script /path/to/file.grendel

  
#### Notes on executing `grendel` files

- make sure the grendel script has no `osc_*` commands if you're not using the Sigilent1020XE oscilloscope. This can be done by using the `noosc` hardware environment when executing the `srcgen` subtool.

- make sure the arduino is connected via the programming port.

- make sure you have flashed `/lab_bench/arduino_due/arduino_driver/arduino_driver.ino` to the board. This program requires the `DueTimer` library be installed.


## Files Generated by the Compiler

`Legno` generates the following files for each benchmark. **do not change the names of these files**:

   - `outputs/default/<BMARK>/abs-circs/`: The abstract circuits generated by `arco`. Each of these files is a json file that should be human readable.
   - `outputs/default/<BMARK>/abs-graphs/`: Graph visualizations of the abstract circuits generated by `arco`.
   - `outputs/default/<BMARK>/conc-circs/`: The concrete circuits generated by `jaunt`. Each of these files is a json file that should be human readable. The prefix of the file is the abstract circuit each concrete circuit is generated from.
   - `outputs/default/<BMARK>/conc-graphs/`: Graph visualizations of the concrete circuits generated by `jaunt`.
   - `outputs/default/<BMARK>/grendel/` : Grendel scripts of concrete circuits. These scripts are written in a low level language that `arduino_client.py` is able to interpret. Grendel files have the math and hardware environment mangled in their names.
   - `outputs/default/<BMARK>/ref-waveforms/`: The reference waveforms for the differential equation. Note: there are bugs in the integration method.
   - `outputs/default/<BMARK>/out-waveforms/`: The waveforms measured from the chip. These waveforms are saved using the `micro_save_waveform` and `osc_save_waveform` commands.
   - `outputs/default/<BMARK>/plots/`: Waveform plots. Typically these plots compare the reference waveforms to the measured waveforms.
   
   
# Installing Legno Dependences

Currently, Legno requires `python-3.7.x`. Make sure you are using the correct python version with the following command:

      python3 --version
      
Install pip3:

      sudo apt-get install python3 python3-pip python3-tk graphviz mailutils tqdm

The Legno compiler requires `python3` and `pip3`. Install the dependences with the following command:

      pip3 install matplotlib scipy numpy pwlf networkx cvxopt colorlover 
      
You need the the following `lab-bench` dependencies for the compiler to interface nicely with the lab bench tooling:

      pip3 install parse construct sklearn fastdtw
      
You need the following dependencies to execute `exp_driver.py`. 
   
      pip3 install seaborn opencv-python numba 
      
### Installing Mosek

_coming soon..._

### Installing GPKIT
 
Install the dependences for GPKit:

      pip3 install pint scipy 

Legno also requires a bleeding edge version of `gpkit`. Clone the following repository:

      git@github.com:convexengineering/gpkit.git
   
switch to the python3 branch:

      git checkout python3
      
Then navigate to it in the command line, and execute the following command in the root directory. It is very important that you have already installed `cvxopt` with pip before running this command:

      pip3 install -e .


# Installing the Lab Bench Dependencies

The lab bench is used to execute `.grendel` scripts on the chip. You need the following packages installed (more details in `lab_bench/README`):

       pip3 install pyserial
       
Next you have to make sure the correct drivers are installed. In the Arduino IDE, open up the Arduino board manager and install `Arduino SAM Boards` version `1.6.11`. Note that you might need to execute the following to properly write to serial:

       sudo usermod -a -G dialout <your usename>

Figure out what thet name of your usb device. If it's `ttyACM0`, then use the `--native` flag. If it's `usbmodem.1411` then omit the native flag.


# Caveats / Notes

- Legno currently does not use the LUT component in its configurations.
- Legno makes use of a hardware specification of the HCDC hardware for compilation (`chip/hcdc.py`).
- make sure all benchmarks/hardware environments/math environments are one word, no spaces or special characters.

# Installing Moira Dependencies

Install the following packages

      pip3 install tinydb
